with active_roster AS
    (SELECT distinct t6.empi
    FROM
    (
        (SELECT empi
            FROM MBR_MONTHS.MBR_MONTHS_CORP15
            inner join bi.d_mbr
                using(mbr_id)
            WHERE CLNDR_MONTH = {t6m} AND CLNDR_YEAR = {t6y}) t6
        INNER JOIN 
        (SELECT empi
            FROM MBR_MONTHS.MBR_MONTHS_CORP15
            inner join bi.d_mbr
                using(mbr_id)
            WHERE CLNDR_MONTH = {t5m} AND CLNDR_YEAR = {t5y}) t5
        ON 	t6.empi = t5.empi
        INNER JOIN 
        (SELECT empi
            FROM MBR_MONTHS.MBR_MONTHS_CORP15
            inner join bi.d_mbr
                using(mbr_id)
            WHERE CLNDR_MONTH = {t4m} AND CLNDR_YEAR = {t4y}) t4
        ON 	t6.empi = t4.empi
        INNER JOIN 
        (SELECT empi
            FROM MBR_MONTHS.MBR_MONTHS_CORP15
            inner join bi.d_mbr
                using(mbr_id)
            WHERE CLNDR_MONTH = {t3m} AND CLNDR_YEAR = {t3y}) t3
        ON 	t6.empi = t3.empi
        INNER JOIN 
        (SELECT empi
            FROM MBR_MONTHS.MBR_MONTHS_CORP15
            inner join bi.d_mbr
                using(mbr_id)
            WHERE CLNDR_MONTH = {t2m} AND CLNDR_YEAR = {t2y}) t2
        ON 	t6.empi = t2.empi
        INNER JOIN 
        (SELECT empi
            FROM MBR_MONTHS.MBR_MONTHS_CORP15
            inner join bi.d_mbr
                using(mbr_id)
            WHERE CLNDR_MONTH = {t1m} AND CLNDR_YEAR = {t1y}
            and floor((to_date('{t_end}') - mbr_DOB) / 365.25) >= 18) t1
        ON 	t6.empi = t1.empi
    )
),
active_members as
(
select * from (
    SELECT Q2.empi,
           Q2.RUN_DATE AS FIRST_RUN_DT
    FROM
        (SELECT Q1.*,
                ROW_NUMBER() OVER 
                    (PARTITION BY Q1.empi 
                     ORDER BY Q1.RUN_DATE
                    ) AS IND_NBR
         FROM
            (SELECT DISTINCT empi, RUN_DATE, YYYYMM
            FROM DIS_REG.F_DIS_REG 
            WHERE DIAB = 1) Q1
         ) Q2
    inner JOIN active_roster m1
        ON Q2.empi = m1.empi
    INNER JOIN DIS_REG.F_DIS_REG dr
        ON Q2.empi = dr.empi
    WHERE Q2.IND_NBR = 1
        AND dr.DIAB_CURR_RUN = 1
        AND dr.YYYYMM = (select max(YYYYMM) from DIS_REG.F_DIS_REG))
full outer join active_roster
    using (empi)
where first_run_dt is not NULL --active and has diabetes
)
,

-- ** STEP 1 ** --
--DIABETIC MEMBERS AND FIRST HIT DATES FROM DISEASE REGISTRY
DM_CMP_01 AS
(
    SELECT Q2.MBR_ID,
           Q2.Run_Date as DIABETES_FIRST_RUN_DT,
           Q2.Currly_Enrld as CURRENTLY_ENROLLED
    FROM
        (SELECT Q1.*,
                ROW_NUMBER() OVER (PARTITION BY Q1.MBR_ID ORDER BY 
                Q1.Run_Date
                ) AS IND_NBR
         FROM
            (SELECT DISTINCT MBR_ID,
                             Run_Date,
                             Currly_Enrld
             FROM DIS_REG.F_DIS_REG 
            WHERE DIAB = 1) Q1
         ) Q2

         
    WHERE Q2.IND_NBR = 1
),    

-- ** STEP 2 ** --
--MEMBER DATA FROM EDW FOR STEP 1
DM_CMP_02 AS
(    SELECT Q2.*
    FROM
        (SELECT Q1.EMPI,
        Q1.MBR_ID,
        Q1.DIABETES_FIRST_RUN_DT,
        Q1.CURRENTLY_ENROLLED,
        Q1.DOB,
        Q1.GENDER_CODE,
        Q1.BUSINESS_SEGMENT,
        Q1.ENRLM_END_DATE,
        ROW_NUMBER() OVER (PARTITION BY Q1.MBR_ID, Q1.BUSINESS_SEGMENT ORDER BY Q1.ENRLM_END_DATE DESC) AS IND_NBR
            FROM
            (SELECT T1.MBR_ID,
                     MBR.EMPI,
                     T1.DIABETES_FIRST_RUN_DT,
                     T1.CURRENTLY_ENROLLED,
                     MBR.DOB,
                     MBR.GENDER_CODE,
                     ENRL.ENRLM_END_DATE,
                     CASE when mbr.empi is not Null then 1 else 0 END AS BUSINESS_SEGMENT
                FROM DM_CMP_01 T1
                    INNER JOIN BI.D_MBR MBR ON T1.MBR_ID = MBR.MBR_ID
                    INNER JOIN BI.F_ENRL ENRL ON MBR.PRIM_KEY = ENRL.MBR_KEY
                    INNER JOIN BI.D_PROD PROD ON ENRL.BEN_PLAN_KEY = PROD.BEN_PLAN_KEY
                WHERE (ENRL.ENRLM_START_DATE <= '{t_start}' AND ENRL.ENRLM_END_DATE >= '{t_end}')) Q1
        ) Q2
    WHERE Q2.IND_NBR = 1
    ORDER BY Q2.MBR_ID, Q2.BUSINESS_SEGMENT
),
-- ** STEP 2.1 ** --
--MOST CURRENT BUSINESS SEGMENT
DM_CMP_ENRLM AS
(    
SELECT DISTINCT BASE.EMPI, BASE.BUSINESS_SEGMENT, BASE.ENRLM_END_DATE
FROM DM_CMP_02 BASE
    INNER JOIN
    (SELECT EMPI, MAX(ENRLM_END_DATE) AS RECENT
     FROM DM_CMP_02
     GROUP BY EMPI) Q1 
     ON (BASE.EMPI = Q1.EMPI AND BASE.ENRLM_END_DATE = Q1.RECENT) 
and base.empi in (select distinct empi from active_members)
),
-- ** STEP 3 ** --
--MEMBER MONTHS FOR MEMBERS IN STEP 2

DM_CMP_MM AS
(SELECT Q1.MBR_ID,
            Q1.EMPI,
            Q1.DIABETES_FIRST_RUN_DT,
            Q1.GENDER_CODE,
            Q1.DOB,
            case when Q1.CAL_YR is not null then 1 else 0 end as CAL_YR,
            Q1.BUSINESS_SEGMENT,
            SUM(MM2.MM_COUNT) AS MM_COUNT
    FROM
        (SELECT DISTINCT T2.MBR_ID,
                         T2.EMPI,
                         T2.DIABETES_FIRST_RUN_DT,
                         T2.GENDER_CODE,
                         T2.DOB,
                         MM.CAL_YR,
                         MM.CAL_MTH,
                         MM.BUSINESS_SEGMENT
                    FROM DM_CMP_02 T2
                        INNER JOIN IHA_INF.MM_DETAIL_R11 MM ON T2.MBR_ID = MM.MBR_ID
                    WHERE MM.CAL_YRMTH BETWEEN '{tstart_yyyymm}' AND '{tend_yyyymm}' 
            ) Q1
                    
    INNER JOIN IHA_INF.MM_DETAIL_R11 MM2 ON Q1.MBR_ID = MM2.MBR_ID 
                AND Q1.CAL_YR = MM2.CAL_YR AND Q1.CAL_MTH = MM2.CAL_MTH 
                AND Q1.BUSINESS_SEGMENT = MM2.BUSINESS_SEGMENT
	where empi in (select distinct empi from active_members)
                
    GROUP BY Q1.MBR_ID, Q1.EMPI, Q1.DIABETES_FIRST_RUN_DT, Q1.GENDER_CODE, Q1.DOB, Q1.CAL_YR, Q1.BUSINESS_SEGMENT
    ),


-- ** STEP 5 ** --
--DATA BASE TABLE - COMPILE DATA FROM STEPS 1-4
DM_CMP_BASE AS
(
    SELECT AGE.EMPI,
           AGE.MBR_ID,
           AGE.CAL_YR,
           AGE.BUSINESS_SEGMENT,
--           AGE.MM_COUNT,
--           AGE.GENDER_CODE,
--           AGE.AGE,
           AGE.DIABETES_FIRST_RUN_DT

    FROM DM_CMP_MM AGE
    where empi in (select distinct empi from active_members)
),


-- CLAIMS PULL --

-- ** STEP 6 ** --
--CLAIMS BASE TABLE FROM EDW
DM_CMP_CLM AS
(
    SELECT CLM.*,
           CASE WHEN PROD.PROD_CATG_CODE IN ('10', '43', 'Commercial') THEN 'COMMERCIAL'
                WHEN PROD.PROD_CATG_CODE IN ('80', 'State') THEN 'MEDICAID'
                WHEN PROD.PROD_CATG_CODE IN ('70', 'Medicare') THEN 'MEDICARE'
                WHEN PROD.PROD_CATG_CODE IN ('90', 'Self-Funded IHSFS') THEN 'SELF-FUNDED'
                ELSE 'OTHER' END AS BUSINESS_SEGMENT
    FROM BI.F_CLM CLM

    INNER JOIN BI.F_CLM_EXT EXT ON CLM.TRANSACTION_REF = EXT.TRANSACTION_REF
    INNER JOIN BI.D_PROD PROD ON CLM.BEN_PLAN_KEY = PROD.BEN_PLAN_KEY

    WHERE (CLM.SERV_LINE_START_DATE BETWEEN '{t_start}' AND '{t_end}')
        AND ((CLM.SRC_SYS = 'HA' AND CLM.CURR_FLAG = 'Y' AND UPPER(CLM.CLM_STAT_CODE) = 'FINAL' AND CLM.CNVRTD_FLAG = 'N') 
            OR (CLM.SRC_SYS = 'MHS' AND CLM.CURR_FLAG = 'Y' AND CLM.RVSD_FROM_CLM_LINE_NBR = '0' AND CLM.RVSD_TO_CLM_LINE_NBR = '0'
            AND (EXT.DEND_FLAG <> 'D' OR EXT.DEND_FLAG IS NULL )))
            
        AND CLM.MBR_ID IN (SELECT DISTINCT MBR_ID 
                           FROM DM_CMP_02)
),
-- INPATIENT CLAIMS BREAKOUT --

-- ** STEP 7 ** --
--INPATIENT OVERALL - ADMISSIONS
DM_CMP_IP_OVR AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS IP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS IP_CST

    FROM DM_CMP_BASE BASE
         LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
         AND BASE.CAL_YR = CLMS.SERV_YEAR 
         AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND CLMS.CLM_FORM_CODE = 'U'
        AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('11', '21')
    
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 8 ** --
--IP AMPUTATION AMP
DM_CMP_IP_AMP AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS IP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS IP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT

    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND CLMS.CLM_FORM_CODE = 'U'
        AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('11', '21') 
        AND (CLMS.ICD_PROC_CODE_1 IN ('0Y6C0Z1','0Y6C0Z2','0Y6C0Z3','0Y6D0Z1','0Y6D0Z2',
            '0Y6D0Z3','0Y6H0Z1','0Y6H0Z2','0Y6H0Z3','0Y6J0Z1','0Y6J0Z2','0Y6J0Z3','0Y6P0Z0',
            '0Y6P0Z1','0Y6P0Z2','0Y6P0Z3','0Y6Q0Z0','0Y6Q0Z1','0Y6Q0Z2','0Y6Q0Z3','0Y6R0Z0',
            '0Y6R0Z1','0Y6R0Z2','0Y6R0Z3','0Y6S0Z0','0Y6S0Z1','0Y6S0Z2','0Y6S0Z3','0Y6T0Z0',
            '0Y6T0Z1','0Y6T0Z2','0Y6T0Z3','0Y6U0Z0','0Y6U0Z1','0Y6U0Z2','0Y6U0Z3','0Y6V0Z0',
            '0Y6V0Z1','0Y6V0Z2','0Y6V0Z3','0Y6W0Z0','0Y6W0Z1','0Y6W0Z2','0Y6W073','0Y6X0Z0',
            '0Y6X0Z1','0Y6X0Z2','0Y6X073','0Y6Y0Z0','0Y6Y0Z1','0Y6Y0Z2','0Y6Y073','0Y6M0Z4',
            '0Y6M0Z5','0Y6M0Z6','0Y6M0Z7','0Y6M0Z8','0Y6M0Z9','0Y6M0ZB','0Y6M0ZC','0Y6M0ZD',
            '0Y6M0ZF','0Y6N0Z4','0Y6N0Z5','0Y6N0Z6','0Y6N0Z7','0Y6N0Z8','0Y6N0Z9','0Y6N0ZB',
            '0Y6N0ZC','0Y6N0ZD','0Y6N0ZF','0Y6M0Z0','0Y6N0Z0','0Y6H0Z3','0Y6J0Z3','0Y6H0Z1',
            '0Y6H0Z2','0Y6H0Z3','0Y6J0Z1','0Y6J0Z2','0Y6J0Z3','0Y6F0ZZ','0Y6G0ZZ','0Y6C0Z1',
            '0Y6C0Z2','0Y6C0Z3','0Y6D0Z1','0Y6D0Z2','0Y6D0Z3','84.1','84.10','84.11','84.12',
            '84.13','84.14','84.15','84.16','84.17') 
            OR
            CLMS.CPT_CODE IN ('27590', '27591', '27592', '27593', '27594', '27595',
            '27596', '27597', '27598', '27880', '27881', '27882', '27884', '27886',
            '27888', '27889', '28800', '28805', '28810', '28820', '28825') 
            OR
            CLMS.SERV_CODE IN ('27590', '27591', '27592', '27593', '27594', '27595',
            '27596', '27597', '27598', '27880', '27881', '27882', '27884', '27886',
            '27888', '27889', '28800', '28805', '28810', '28820', '28825'))
            
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),
-- ** STEP 10 ** --
--IP CAD
DM_CMP_IP_CAD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS IP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS IP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND CLMS.CLM_FORM_CODE = 'U' 
        AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('11', '21') 
        AND ((CLMS.CLM_PRIN_DIAG_CODE IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
            '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
            'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_1 IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
            '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
            'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_2 IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
            '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
            'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9')) 
            OR
            ((CLMS.ICD_PROC_CODE_1 IN ('00.66',	'36.0',	'36.03',	'36.04',	'36.07',	
            '36.09',	'36.1',	'36.10',	'36.11',	'36.12',	'36.13',	'36.14',	'36.15',	
            '36.16',	'36.17',	'36.19',	'02703ZZ',	'02704ZZ',	'02713ZZ',	'02714ZZ',	
            '02723ZZ',	'02724ZZ',	'02733ZZ',	'02734ZZ',	'02700ZZ',	'02710ZZ',	
            '02720ZZ',	'02730ZZ',	'02C00ZZ',	'02C10ZZ',	'02C20ZZ',	'02C30ZZ',	
            '3E07017',	'3E070PZ',	'3E07317',	'3E073PZ',	'02C03ZZ',	'02C04ZZ',	
            '02C13ZZ',	'02C14ZZ',	'02C23ZZ',	'02C24ZZ',	'02C33ZZ',	'02C34ZZ',	
            '0210093',	'02100A3',	'02100J3',	'02100K3',	'02100Z3',	'0210493',	
            '02104A3',	'02104J3',	'02104K3',	'02104Z3',	'021008W',	'021009W',	
            '02100AW',	'02100JW',	'02100KW',	'021048W',	'021049W',	'02104AW',	
            '02104JW',	'02104KW',	'021108W',	'021109W',	'02110AW',	'02110JW',	
            '02110KW',	'021148W',	'021149W',	'02114AW',	'02114JW',	'02114KW',	
            '021208W',	'021209W',	'02120AW',	'02120JW',	'02120KW',	'021248W',	
            '021249W',	'02124AW',	'02124JW',	'02124KW',	'021308W',	'021309W',	
            '02130AW',	'02130JW',	'02130KW',	'021348W',	'021349W',	'02134AW',	
            '02134JW',	'02134KW',	'0210088',	'0210089',	'021008C',	'0210098',	
            '0210099',	'021009C',	'02100A8',	'02100A9',	'02100AC',	'02100J8',	
            '02100J9',	'02100JC',	'02100K8',	'02100K9',	'02100KC',	'02100Z8',	
            '02100Z9',	'02100ZC',	'0210488',	'0210489',	'021048C',	'0210498',	
            '0210499',	'021049C',	'02104A8',	'02104A9',	'02104AC',	'02104J8',	
            '02104J9',	'02104JC',	'02104K8',	'02104K9',	'02104KC',	'02104Z8',	
            '02104Z9',	'02104ZC',	'0211088',	'0211089',	'021108C',	'0211098',	
            '0211099',	'021109C',	'02110A8',	'02110A9',	'02110AC',	'02110J8',	
            '02110J9',	'02110JC',	'02110K8',	'02110K9',	'02110KC',	'02110Z8',	
            '02110Z9',	'02110ZC',	'0211488',	'0211489',	'021148C',	'0211498',	
            '0211499',	'021149C',	'02114A8',	'02114A9',	'02114AC',	'02114J8',	
            '02114J9',	'02114JC',	'02114K8',	'02114K9',	'02114KC',	'02114Z8',	
            '02114Z9',	'02114ZC',	'021208C',	'021209C',	'02120AC',	'02120JC',	
            '02120KC',	'02120ZC',	'021248C',	'021249C',	'02124AC',	'02124JC',	
            '02124KC',	'02124ZC',	'021308C',	'021309C',	'02130AC',	'02130JC',	
            '02130KC',	'02130ZC',	'021348C',	'021349C',	'02134AC',	'02134JC',	
            '02134KC',	'02134ZC',	'021008F',	'021009F',	'02100AF',	'02100JF',	
            '02100KF',	'02100ZF',	'021048F',	'021049F',	'02104AF',	'02104JF',	
            '02104KF',	'02104ZF',	'0210083',	'0210093',	'02100A3',	'02100J3',	
            '02100K3',	'02100Z3',	'0210483',	'0210493',	'02104A3',	'02104J3',	
            '02104K3',	'02104Z3') 
            OR
            CLMS.ICD_PROC_CODE_2 IN ('00.66',	'36.0',	'36.03',	'36.04',	'36.07',	
            '36.09',	'36.1',	'36.10',	'36.11',	'36.12',	'36.13',	'36.14',	'36.15',	
            '36.16',	'36.17',	'36.19',	'02703ZZ',	'02704ZZ',	'02713ZZ',	'02714ZZ',	
            '02723ZZ',	'02724ZZ',	'02733ZZ',	'02734ZZ',	'02700ZZ',	'02710ZZ',	
            '02720ZZ',	'02730ZZ',	'02C00ZZ',	'02C10ZZ',	'02C20ZZ',	'02C30ZZ',	
            '3E07017',	'3E070PZ',	'3E07317',	'3E073PZ',	'02C03ZZ',	'02C04ZZ',	
            '02C13ZZ',	'02C14ZZ',	'02C23ZZ',	'02C24ZZ',	'02C33ZZ',	'02C34ZZ',	
            '0210093',	'02100A3',	'02100J3',	'02100K3',	'02100Z3',	'0210493',	
            '02104A3',	'02104J3',	'02104K3',	'02104Z3',	'021008W',	'021009W',	
            '02100AW',	'02100JW',	'02100KW',	'021048W',	'021049W',	'02104AW',	
            '02104JW',	'02104KW',	'021108W',	'021109W',	'02110AW',	'02110JW',	
            '02110KW',	'021148W',	'021149W',	'02114AW',	'02114JW',	'02114KW',	
            '021208W',	'021209W',	'02120AW',	'02120JW',	'02120KW',	'021248W',	
            '021249W',	'02124AW',	'02124JW',	'02124KW',	'021308W',	'021309W',	
            '02130AW',	'02130JW',	'02130KW',	'021348W',	'021349W',	'02134AW',	
            '02134JW',	'02134KW',	'0210088',	'0210089',	'021008C',	'0210098',	
            '0210099',	'021009C',	'02100A8',	'02100A9',	'02100AC',	'02100J8',	
            '02100J9',	'02100JC',	'02100K8',	'02100K9',	'02100KC',	'02100Z8',	
            '02100Z9',	'02100ZC',	'0210488',	'0210489',	'021048C',	'0210498',	
            '0210499',	'021049C',	'02104A8',	'02104A9',	'02104AC',	'02104J8',	
            '02104J9',	'02104JC',	'02104K8',	'02104K9',	'02104KC',	'02104Z8',	
            '02104Z9',	'02104ZC',	'0211088',	'0211089',	'021108C',	'0211098',	
            '0211099',	'021109C',	'02110A8',	'02110A9',	'02110AC',	'02110J8',	
            '02110J9',	'02110JC',	'02110K8',	'02110K9',	'02110KC',	'02110Z8',	
            '02110Z9',	'02110ZC',	'0211488',	'0211489',	'021148C',	'0211498',	
            '0211499',	'021149C',	'02114A8',	'02114A9',	'02114AC',	'02114J8',	
            '02114J9',	'02114JC',	'02114K8',	'02114K9',	'02114KC',	'02114Z8',	
            '02114Z9',	'02114ZC',	'021208C',	'021209C',	'02120AC',	'02120JC',	
            '02120KC',	'02120ZC',	'021248C',	'021249C',	'02124AC',	'02124JC',	
            '02124KC',	'02124ZC',	'021308C',	'021309C',	'02130AC',	'02130JC',	
            '02130KC',	'02130ZC',	'021348C',	'021349C',	'02134AC',	'02134JC',	
            '02134KC',	'02134ZC',	'021008F',	'021009F',	'02100AF',	'02100JF',	
            '02100KF',	'02100ZF',	'021048F',	'021049F',	'02104AF',	'02104JF',	
            '02104KF',	'02104ZF',	'0210083',	'0210093',	'02100A3',	'02100J3',	
            '02100K3',	'02100Z3',	'0210483',	'0210493',	'02104A3',	'02104J3',	
            '02104K3',	'02104Z3')) 
            OR
            (CLMS.CPT_CODE IN ('33140','92980','92981','92982','92984','92985','92986','92995',
            '92996','33510','33511','33512','33513','33514','33515','33516','33517','33518',
            '33519','33520','33521','33522','33523','33533','33534','33535','33536','33572') 
            OR
            CLMS.SERV_CODE IN ('33140','92980','92981','92982','92984','92985','92986','92995',
            '92996','33510','33511','33512','33513','33514','33515','33516','33517','33518',
            '33519','33520','33521','33522','33523','33533','33534','33535','33536','33572'))))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),


-- ** STEP 11 ** --
--IP CHF
DM_CMP_IP_CHF AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS IP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS IP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
    AND CLMS.CLM_FORM_CODE = 'U' 
    AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('11', '21') 
    AND (CLMS.CLM_PRIN_DIAG_CODE IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
        'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
        'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
        'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
        'I50.89','I50.9') 
        OR
        CLMS.CLM_OTHER_DIAG_CODE_1 IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
        'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
        'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
        'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
        'I50.89','I50.9') 
        OR
        CLMS.CLM_OTHER_DIAG_CODE_2 IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
        'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
        'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
        'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
        'I50.89','I50.9'))
        
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 12 ** --
--IP ESRD
DM_CMP_IP_ESRD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS IP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS IP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
    AND CLMS.CLM_FORM_CODE = 'U' 
    AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('11', '21') 
    AND (CLMS.CPT_CODE IN ('90918', '90919', '90920', '90921', '90922', '90923',
        '90924', '90925', '90935', '90937', '90940', '90951', '90952', '90953',
        '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961',
        '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969',
        '90970') 
        OR
        CLMS.SERV_CODE IN ('90918', '90919', '90920', '90921', '90922', '90923',
        '90924', '90925', '90935', '90937', '90940', '90951', '90952', '90953',
        '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961',
        '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969',
        '90970'))
        
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 13 ** --
--IP HEMORRHAGIC STROKE HS
DM_CMP_IP_HS AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS IP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS IP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND CLMS.CLM_FORM_CODE = 'U' 
        AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('11', '21') 
        AND (CLMS.CLM_PRIN_DIAG_CODE IN ('432.0', '432.1', '432.2', '432.3', '432.4', '432.5',
            '432.6', '432.7', '432.8', '432.9', 'I61.0', 'I61.1', 'I61.2', 'I61.3',
            'I61.4', 'I61.5', 'I61.6', 'I61.8', 'I61.9', 'I62', 'I62.0', 'I62.00',
            'I62.01', 'I62.02', 'I62.03', 'I62.1', 'I62.9') 
            OR 
            CLMS.CLM_PRIN_DIAG_CODE LIKE '430%' OR CLMS.CLM_PRIN_DIAG_CODE LIKE '431%')

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 14 ** --
--IP ISHEMIC HEART DISEASE IHD
DM_CMP_IP_IHD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS IP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS IP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND CLMS.CLM_FORM_CODE = 'U' 
        AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('11', '21') 
        AND (CLMS.CLM_PRIN_DIAG_CODE IN ('411','411.0','411.1','411.8','411.81','411.89','413',
            '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
            '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
            'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
            'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
            'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
            'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
            'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
            'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
            'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
            'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_1 IN ('411','411.0','411.1','411.8','411.81','411.89','413',
            '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
            '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
            'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
            'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
            'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
            'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
            'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
            'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
            'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
            'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_2 IN ('411','411.0','411.1','411.8','411.81','411.89','413',
            '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
            '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
            'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
            'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
            'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
            'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
            'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
            'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
            'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
            'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9'))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 15 ** --
--IP ISCHEMIC STROKE IS
DM_CMP_IP_IS AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS IP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS IP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND CLMS.CLM_FORM_CODE = 'U' 
        AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('11', '21') 
        AND (CLMS.CLM_PRIN_DIAG_CODE IN ('433.01', '433.11', '433.21', '433.31', '433.41', '433.81',
            '433.91', '434.01', '434.11', '434.91', 'I63', 'I63.0', 'I63.00',
            'I63.01', 'I63.011', 'I63.012', 'I63.013', 'I63.019', 'I63.02', 'I63.03',
            'I63.031', 'I63.032', 'I63.033', 'I63.039', 'I63.09', '163.1', 'I63.10',
            'I63.11', 'I63.111', 'I63.112', 'I63.113', 'I63.119', 'I63.12', 'I63.12',
            'I63.13', 'I63.131', 'I63.132', 'I63.133', 'I63.139', 'I63.19', 'I63.2',
            'I63.20', 'I63.21', 'I63.211', 'I63.212', 'I63.213', 'I63.219', 'I63.22',
            'I63.23', 'I63.231', 'I63.232', 'I63.233', 'I63.239', 'I63.29', 'I63.3',
            'I63.30', 'I63.31', 'I63.311', 'I63.312', 'I63.313', 'I63.319', 'I63.32',
            'I63.321', 'I63.322', 'I63.323', 'I63.329', 'I63.33', 'I63.331', 'I63.332',
            'I63.333', 'I63.339', 'I63.34', 'I63.341', 'I63.342', 'I63.343', 'I63.349',
            'I63.39', 'I63.4', 'I63.40', 'I63.41', 'I63.411', 'I63.412', 'I63.413',
            'I63.419', 'I63.42', 'I63.421', 'I63.422', 'I63.423', 'I63.429', 'I63.43',
            'I63.431', 'I63.432', 'I63.433', 'I63.439', 'I63.44', 'I63.441', 'I63.442',
            'I63.443', 'I63.449', 'I63.49', 'I63.5', 'I63.50', 'I63.51', 'I63.511',
            'I63.512', 'I63.513', 'I63.519', 'I63.52', 'I63.521', 'I63.522','I63.523',
            'I63.529', 'I63.53', 'I63.531', 'I63.532', 'I63.533', 'I63.539', 'I63.54',
            'I63.541', 'I63.542', 'I63.543', 'I63.549', 'I63.59', 'I63.6', 'I63.8',
            'I63.9', 'I63.81','I63.89') 
            OR 
            CLMS.CLM_PRIN_DIAG_CODE LIKE '436%')

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- COMPILE ALL IP DATA TABLES --

-- ** STEP 16 ** --
--IP DATA
DM_CMP_IP_ADD AS
(
    SELECT BASE.*,
           OVR.IP_UTL AS IP_OVR_UTL,
           OVR.IP_CST AS IP_OVR_CST,
           AMP.IP_UTL AS IP_AMP_UTL,
           AMP.IP_CST AS IP_AMP_CST,
           CAD.IP_UTL AS IP_CAD_UTL,
           CAD.IP_CST AS IP_CAD_CST,
           CHF.IP_UTL AS IP_CHF_UTL,
           CHF.IP_CST AS IP_CHF_CST,
           ESRD.IP_UTL AS IP_ESRD_UTL,
           ESRD.IP_CST AS IP_ESRD_CST,
           HS.IP_UTL AS IP_HS_UTL,
           HS.IP_CST AS IP_HS_CST,
           IHD.IP_UTL AS IP_IHD_UTL,
           IHD.IP_CST AS IP_IHD_CST,
           IST.IP_UTL AS IP_IST_UTL,
           IST.IP_CST AS IP_IST_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_IP_OVR OVR ON BASE.MBR_ID = OVR.MBR_ID AND BASE.CAL_YR = OVR.CAL_YR AND BASE.BUSINESS_SEGMENT = OVR.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_IP_AMP AMP ON BASE.MBR_ID = AMP.MBR_ID AND BASE.CAL_YR = AMP.CAL_YR AND BASE.BUSINESS_SEGMENT = AMP.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_IP_CAD CAD ON BASE.MBR_ID = CAD.MBR_ID AND BASE.CAL_YR = CAD.CAL_YR AND BASE.BUSINESS_SEGMENT = CAD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_IP_CHF CHF ON BASE.MBR_ID = CHF.MBR_ID AND BASE.CAL_YR = CHF.CAL_YR AND BASE.BUSINESS_SEGMENT = CHF.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_IP_ESRD ESRD ON BASE.MBR_ID = ESRD.MBR_ID AND BASE.CAL_YR = ESRD.CAL_YR AND BASE.BUSINESS_SEGMENT = ESRD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_IP_HS HS ON BASE.MBR_ID = HS.MBR_ID AND BASE.CAL_YR = HS.CAL_YR AND BASE.BUSINESS_SEGMENT = HS.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_IP_IHD IHD ON BASE.MBR_ID = IHD.MBR_ID AND BASE.CAL_YR = IHD.CAL_YR AND BASE.BUSINESS_SEGMENT = IHD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_IP_IS IST ON BASE.MBR_ID = IST.MBR_ID AND BASE.CAL_YR = IST.CAL_YR AND BASE.BUSINESS_SEGMENT = IST.BUSINESS_SEGMENT
),


-- ER CLAIMS BREAKOUT --

-- ** STEP 17 ** --
--ER OVERALL - VISITS
DM_CMP_ER_OVR AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS ER_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS ER_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND (((CLMS.SERV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459') 
            OR CLMS.REV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459')) 
            OR CLMS.SERV_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.CPT_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.SERV_CODE IN ('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.HCPCS_CODE IN('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR CLMS.POS_CODE = '23')

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),


-- ** STEP 18 ** --
--ER AMPUTATION AMP
DM_CMP_ER_AMP AS
(    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS ER_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS ER_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND (((CLMS.SERV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459') 
                OR CLMS.REV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459')) 
                OR CLMS.SERV_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
                OR (CLMS.CPT_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
                OR (CLMS.SERV_CODE IN ('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
                OR (CLMS.HCPCS_CODE IN('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
                OR CLMS.POS_CODE = '23') 
        AND (CLMS.ICD_PROC_CODE_1 IN ('0Y6C0Z1','0Y6C0Z2','0Y6C0Z3','0Y6D0Z1','0Y6D0Z2',
            '0Y6D0Z3','0Y6H0Z1','0Y6H0Z2','0Y6H0Z3','0Y6J0Z1','0Y6J0Z2','0Y6J0Z3','0Y6P0Z0',
            '0Y6P0Z1','0Y6P0Z2','0Y6P0Z3','0Y6Q0Z0','0Y6Q0Z1','0Y6Q0Z2','0Y6Q0Z3','0Y6R0Z0',
            '0Y6R0Z1','0Y6R0Z2','0Y6R0Z3','0Y6S0Z0','0Y6S0Z1','0Y6S0Z2','0Y6S0Z3','0Y6T0Z0',
            '0Y6T0Z1','0Y6T0Z2','0Y6T0Z3','0Y6U0Z0','0Y6U0Z1','0Y6U0Z2','0Y6U0Z3','0Y6V0Z0',
            '0Y6V0Z1','0Y6V0Z2','0Y6V0Z3','0Y6W0Z0','0Y6W0Z1','0Y6W0Z2','0Y6W073','0Y6X0Z0',
            '0Y6X0Z1','0Y6X0Z2','0Y6X073','0Y6Y0Z0','0Y6Y0Z1','0Y6Y0Z2','0Y6Y073','0Y6M0Z4',
            '0Y6M0Z5','0Y6M0Z6','0Y6M0Z7','0Y6M0Z8','0Y6M0Z9','0Y6M0ZB','0Y6M0ZC','0Y6M0ZD',
            '0Y6M0ZF','0Y6N0Z4','0Y6N0Z5','0Y6N0Z6','0Y6N0Z7','0Y6N0Z8','0Y6N0Z9','0Y6N0ZB',
            '0Y6N0ZC','0Y6N0ZD','0Y6N0ZF','0Y6M0Z0','0Y6N0Z0','0Y6H0Z3','0Y6J0Z3','0Y6H0Z1',
            '0Y6H0Z2','0Y6H0Z3','0Y6J0Z1','0Y6J0Z2','0Y6J0Z3','0Y6F0ZZ','0Y6G0ZZ','0Y6C0Z1',
            '0Y6C0Z2','0Y6C0Z3','0Y6D0Z1','0Y6D0Z2','0Y6D0Z3','84.1','84.10','84.11','84.12',
            '84.13','84.14','84.15','84.16','84.17') 
            OR
            CLMS.CPT_CODE IN ('27590', '27591', '27592', '27593', '27594', '27595',
            '27596', '27597', '27598', '27880', '27881', '27882', '27884', '27886',
            '27888', '27889', '28800', '28805', '28810', '28820', '28825') 
            OR
            CLMS.SERV_CODE IN ('27590', '27591', '27592', '27593', '27594', '27595',
            '27596', '27597', '27598', '27880', '27881', '27882', '27884', '27886',
            '27888', '27889', '28800', '28805', '28810', '28820', '28825'))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),
-- ** STEP 20 ** --
--ER CAD
DM_CMP_ER_CAD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS ER_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS ER_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND (((CLMS.SERV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459') 
            OR CLMS.REV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459')) 
            OR CLMS.SERV_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.CPT_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.SERV_CODE IN ('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.HCPCS_CODE IN('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR CLMS.POS_CODE = '23') 
        AND ((CLMS.CLM_PRIN_DIAG_CODE IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
            '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
            'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_1 IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
            '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
            'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_2 IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
            '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
            'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9')) 
            OR
            ((CLMS.ICD_PROC_CODE_1 IN ('00.66',	'36.0',	'36.03',	'36.04',	'36.07',	
            '36.09',	'36.1',	'36.10',	'36.11',	'36.12',	'36.13',	'36.14',	'36.15',	
            '36.16',	'36.17',	'36.19',	'02703ZZ',	'02704ZZ',	'02713ZZ',	'02714ZZ',	
            '02723ZZ',	'02724ZZ',	'02733ZZ',	'02734ZZ',	'02700ZZ',	'02710ZZ',	
            '02720ZZ',	'02730ZZ',	'02C00ZZ',	'02C10ZZ',	'02C20ZZ',	'02C30ZZ',	
            '3E07017',	'3E070PZ',	'3E07317',	'3E073PZ',	'02C03ZZ',	'02C04ZZ',	
            '02C13ZZ',	'02C14ZZ',	'02C23ZZ',	'02C24ZZ',	'02C33ZZ',	'02C34ZZ',	
            '0210093',	'02100A3',	'02100J3',	'02100K3',	'02100Z3',	'0210493',	
            '02104A3',	'02104J3',	'02104K3',	'02104Z3',	'021008W',	'021009W',	
            '02100AW',	'02100JW',	'02100KW',	'021048W',	'021049W',	'02104AW',	
            '02104JW',	'02104KW',	'021108W',	'021109W',	'02110AW',	'02110JW',	
            '02110KW',	'021148W',	'021149W',	'02114AW',	'02114JW',	'02114KW',	
            '021208W',	'021209W',	'02120AW',	'02120JW',	'02120KW',	'021248W',	
            '021249W',	'02124AW',	'02124JW',	'02124KW',	'021308W',	'021309W',	
            '02130AW',	'02130JW',	'02130KW',	'021348W',	'021349W',	'02134AW',	
            '02134JW',	'02134KW',	'0210088',	'0210089',	'021008C',	'0210098',	
            '0210099',	'021009C',	'02100A8',	'02100A9',	'02100AC',	'02100J8',	
            '02100J9',	'02100JC',	'02100K8',	'02100K9',	'02100KC',	'02100Z8',	
            '02100Z9',	'02100ZC',	'0210488',	'0210489',	'021048C',	'0210498',	
            '0210499',	'021049C',	'02104A8',	'02104A9',	'02104AC',	'02104J8',	
            '02104J9',	'02104JC',	'02104K8',	'02104K9',	'02104KC',	'02104Z8',	
            '02104Z9',	'02104ZC',	'0211088',	'0211089',	'021108C',	'0211098',	
            '0211099',	'021109C',	'02110A8',	'02110A9',	'02110AC',	'02110J8',	
            '02110J9',	'02110JC',	'02110K8',	'02110K9',	'02110KC',	'02110Z8',	
            '02110Z9',	'02110ZC',	'0211488',	'0211489',	'021148C',	'0211498',	
            '0211499',	'021149C',	'02114A8',	'02114A9',	'02114AC',	'02114J8',	
            '02114J9',	'02114JC',	'02114K8',	'02114K9',	'02114KC',	'02114Z8',	
            '02114Z9',	'02114ZC',	'021208C',	'021209C',	'02120AC',	'02120JC',	
            '02120KC',	'02120ZC',	'021248C',	'021249C',	'02124AC',	'02124JC',	
            '02124KC',	'02124ZC',	'021308C',	'021309C',	'02130AC',	'02130JC',	
            '02130KC',	'02130ZC',	'021348C',	'021349C',	'02134AC',	'02134JC',	
            '02134KC',	'02134ZC',	'021008F',	'021009F',	'02100AF',	'02100JF',	
            '02100KF',	'02100ZF',	'021048F',	'021049F',	'02104AF',	'02104JF',	
            '02104KF',	'02104ZF',	'0210083',	'0210093',	'02100A3',	'02100J3',	
            '02100K3',	'02100Z3',	'0210483',	'0210493',	'02104A3',	'02104J3',	
            '02104K3',	'02104Z3') 
            OR
            CLMS.ICD_PROC_CODE_2 IN ('00.66',	'36.0',	'36.03',	'36.04',	'36.07',	
            '36.09',	'36.1',	'36.10',	'36.11',	'36.12',	'36.13',	'36.14',	'36.15',	
            '36.16',	'36.17',	'36.19',	'02703ZZ',	'02704ZZ',	'02713ZZ',	'02714ZZ',	
            '02723ZZ',	'02724ZZ',	'02733ZZ',	'02734ZZ',	'02700ZZ',	'02710ZZ',	
            '02720ZZ',	'02730ZZ',	'02C00ZZ',	'02C10ZZ',	'02C20ZZ',	'02C30ZZ',	
            '3E07017',	'3E070PZ',	'3E07317',	'3E073PZ',	'02C03ZZ',	'02C04ZZ',	
            '02C13ZZ',	'02C14ZZ',	'02C23ZZ',	'02C24ZZ',	'02C33ZZ',	'02C34ZZ',	
            '0210093',	'02100A3',	'02100J3',	'02100K3',	'02100Z3',	'0210493',	
            '02104A3',	'02104J3',	'02104K3',	'02104Z3',	'021008W',	'021009W',	
            '02100AW',	'02100JW',	'02100KW',	'021048W',	'021049W',	'02104AW',	
            '02104JW',	'02104KW',	'021108W',	'021109W',	'02110AW',	'02110JW',	
            '02110KW',	'021148W',	'021149W',	'02114AW',	'02114JW',	'02114KW',	
            '021208W',	'021209W',	'02120AW',	'02120JW',	'02120KW',	'021248W',	
            '021249W',	'02124AW',	'02124JW',	'02124KW',	'021308W',	'021309W',	
            '02130AW',	'02130JW',	'02130KW',	'021348W',	'021349W',	'02134AW',	
            '02134JW',	'02134KW',	'0210088',	'0210089',	'021008C',	'0210098',	
            '0210099',	'021009C',	'02100A8',	'02100A9',	'02100AC',	'02100J8',	
            '02100J9',	'02100JC',	'02100K8',	'02100K9',	'02100KC',	'02100Z8',	
            '02100Z9',	'02100ZC',	'0210488',	'0210489',	'021048C',	'0210498',	
            '0210499',	'021049C',	'02104A8',	'02104A9',	'02104AC',	'02104J8',	
            '02104J9',	'02104JC',	'02104K8',	'02104K9',	'02104KC',	'02104Z8',	
            '02104Z9',	'02104ZC',	'0211088',	'0211089',	'021108C',	'0211098',	
            '0211099',	'021109C',	'02110A8',	'02110A9',	'02110AC',	'02110J8',	
            '02110J9',	'02110JC',	'02110K8',	'02110K9',	'02110KC',	'02110Z8',	
            '02110Z9',	'02110ZC',	'0211488',	'0211489',	'021148C',	'0211498',	
            '0211499',	'021149C',	'02114A8',	'02114A9',	'02114AC',	'02114J8',	
            '02114J9',	'02114JC',	'02114K8',	'02114K9',	'02114KC',	'02114Z8',	
            '02114Z9',	'02114ZC',	'021208C',	'021209C',	'02120AC',	'02120JC',	
            '02120KC',	'02120ZC',	'021248C',	'021249C',	'02124AC',	'02124JC',	
            '02124KC',	'02124ZC',	'021308C',	'021309C',	'02130AC',	'02130JC',	
            '02130KC',	'02130ZC',	'021348C',	'021349C',	'02134AC',	'02134JC',	
            '02134KC',	'02134ZC',	'021008F',	'021009F',	'02100AF',	'02100JF',	
            '02100KF',	'02100ZF',	'021048F',	'021049F',	'02104AF',	'02104JF',	
            '02104KF',	'02104ZF',	'0210083',	'0210093',	'02100A3',	'02100J3',	
            '02100K3',	'02100Z3',	'0210483',	'0210493',	'02104A3',	'02104J3',	
            '02104K3',	'02104Z3')) 
            OR
            (CLMS.CPT_CODE IN ('33140','92980','92981','92982','92984','92985','92986','92995',
            '92996','33510','33511','33512','33513','33514','33515','33516','33517','33518',
            '33519','33520','33521','33522','33523','33533','33534','33535','33536','33572') 
            OR
            CLMS.SERV_CODE IN ('33140','92980','92981','92982','92984','92985','92986','92995',
            '92996','33510','33511','33512','33513','33514','33515','33516','33517','33518',
            '33519','33520','33521','33522','33523','33533','33534','33535','33536','33572'))))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 21 ** --
--ER CHF
DM_CMP_ER_CHF AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS ER_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS ER_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND (((CLMS.SERV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459') OR CLMS.REV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459')) 
            OR CLMS.SERV_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.CPT_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.SERV_CODE IN ('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.HCPCS_CODE IN('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR CLMS.POS_CODE = '23') 
        AND (CLMS.CLM_PRIN_DIAG_CODE IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
            'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
            'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
            'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
            'I50.89','I50.9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_1 IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
            'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
            'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
            'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
            'I50.89','I50.9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_2 IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
            'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
            'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
            'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
            'I50.89','I50.9'))
            
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 22 ** --
--ER ESRD
DM_CMP_ER_ESRD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS ER_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS ER_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND (((CLMS.SERV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459') OR CLMS.REV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459')) 
            OR CLMS.SERV_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.CPT_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.SERV_CODE IN ('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.HCPCS_CODE IN('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR CLMS.POS_CODE = '23') 
        AND (CLMS.CPT_CODE IN ('90918', '90919', '90920', '90921', '90922', '90923',
            '90924', '90925', '90935', '90937', '90940', '90951', '90952', '90953',
            '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961',
            '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969',
            '90970') 
            OR
            CLMS.SERV_CODE IN ('90918', '90919', '90920', '90921', '90922', '90923',
            '90924', '90925', '90935', '90937', '90940', '90951', '90952', '90953',
            '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961',
            '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969',
            '90970'))
            
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 23 ** --
--ER HEMORRHAGIC STROKE HS
DM_CMP_ER_HS AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS ER_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS ER_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
        
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
    AND (((CLMS.SERV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459') OR CLMS.REV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459')) 
        OR CLMS.SERV_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
        OR (CLMS.CPT_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
        OR (CLMS.SERV_CODE IN ('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
        OR (CLMS.HCPCS_CODE IN('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
        OR CLMS.POS_CODE = '23') 
    AND (CLMS.CLM_PRIN_DIAG_CODE IN ('432.0', '432.1', '432.2', '432.3', '432.4', '432.5',
        '432.6', '432.7', '432.8', '432.9', 'I61.0', 'I61.1', 'I61.2', 'I61.3',
        'I61.4', 'I61.5', 'I61.6', 'I61.8', 'I61.9', 'I62', 'I62.0', 'I62.00',
        'I62.01', 'I62.02', 'I62.03', 'I62.1', 'I62.9') 
        OR 
        CLMS.CLM_PRIN_DIAG_CODE LIKE '430%' OR CLMS.CLM_PRIN_DIAG_CODE LIKE '431%')
    
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 24 ** --
--ER ISHEMIC HEART DISEASE IHD
DM_CMP_ER_IHD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS ER_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS ER_CST

    FROM DM_CMP_BASE BASE
         LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
         AND BASE.CAL_YR = CLMS.SERV_YEAR 
         AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
         
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND (((CLMS.SERV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459') OR CLMS.REV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459')) 
            OR CLMS.SERV_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.CPT_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.SERV_CODE IN ('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.HCPCS_CODE IN('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR CLMS.POS_CODE = '23') 
        AND (CLMS.CLM_PRIN_DIAG_CODE IN ('411','411.0','411.1','411.8','411.81','411.89','413',
            '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
            '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
            'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
            'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
            'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
            'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
            'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
            'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
            'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
            'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_1 IN ('411','411.0','411.1','411.8','411.81','411.89','413',
            '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
            '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
            'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
            'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
            'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
            'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
            'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
            'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
            'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
            'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9') 
            OR
            CLMS.CLM_OTHER_DIAG_CODE_2 IN ('411','411.0','411.1','411.8','411.81','411.89','413',
            '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
            '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
            'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
            'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
            'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
            'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
            'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
            'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
            'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
            'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9'))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 25 ** --
--ER ISCHEMIC STROKE IS
DM_CMP_ER_IS AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS ER_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS ER_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
        AND BASE.CAL_YR = CLMS.SERV_YEAR 
        AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT

    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND (((CLMS.SERV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459') OR CLMS.REV_CODE IN ('0450', '0451', '0452', '0459', '450', '451', '452', '459')) 
            OR CLMS.SERV_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.CPT_CODE LIKE '9928%' AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.SERV_CODE IN ('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR (CLMS.HCPCS_CODE IN('G0380', 'G0381', 'G0382', 'G0383', 'G0384', 'G0257') AND (CLMS.REV_CODE NOT IN ('0456', '0516', '0526', '456', '516', '526') OR CLMS.REV_CODE IS NULL)) 
            OR CLMS.POS_CODE = '23') 
        AND (CLMS.CLM_PRIN_DIAG_CODE IN ('433.01', '433.11', '433.21', '433.31', '433.41', '433.81',
            '433.91', '434.01', '434.11', '434.91', 'I63', 'I63.0', 'I63.00',
            'I63.01', 'I63.011', 'I63.012', 'I63.013', 'I63.019', 'I63.02', 'I63.03',
            'I63.031', 'I63.032', 'I63.033', 'I63.039', 'I63.09', '163.1', 'I63.10',
            'I63.11', 'I63.111', 'I63.112', 'I63.113', 'I63.119', 'I63.12', 'I63.12',
            'I63.13', 'I63.131', 'I63.132', 'I63.133', 'I63.139', 'I63.19', 'I63.2',
            'I63.20', 'I63.21', 'I63.211', 'I63.212', 'I63.213', 'I63.219', 'I63.22',
            'I63.23', 'I63.231', 'I63.232', 'I63.233', 'I63.239', 'I63.29', 'I63.3',
            'I63.30', 'I63.31', 'I63.311', 'I63.312', 'I63.313', 'I63.319', 'I63.32',
            'I63.321', 'I63.322', 'I63.323', 'I63.329', 'I63.33', 'I63.331', 'I63.332',
            'I63.333', 'I63.339', 'I63.34', 'I63.341', 'I63.342', 'I63.343', 'I63.349',
            'I63.39', 'I63.4', 'I63.40', 'I63.41', 'I63.411', 'I63.412', 'I63.413',
            'I63.419', 'I63.42', 'I63.421', 'I63.422', 'I63.423', 'I63.429', 'I63.43',
            'I63.431', 'I63.432', 'I63.433', 'I63.439', 'I63.44', 'I63.441', 'I63.442',
            'I63.443', 'I63.449', 'I63.49', 'I63.5', 'I63.50', 'I63.51', 'I63.511',
            'I63.512', 'I63.513', 'I63.519', 'I63.52', 'I63.521', 'I63.522','I63.523',
            'I63.529', 'I63.53', 'I63.531', 'I63.532', 'I63.533', 'I63.539', 'I63.54',
            'I63.541', 'I63.542', 'I63.543', 'I63.549', 'I63.59', 'I63.6', 'I63.8',
            'I63.9', 'I63.81','I63.89') 
            OR CLMS.CLM_PRIN_DIAG_CODE LIKE '436%')
            
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- COMPILES ALL ER DATA TO PREVIOUS IP + MEMBERSHIP TABLE --

-- ** STEP 26 ** --
--ER DATA
DM_CMP_ER_ADD AS
(
    SELECT BASE.*,
           OVR.ER_UTL AS ER_OVR_UTL,
           OVR.ER_CST AS ER_OVR_CST,
           AMP.ER_UTL AS ER_AMP_UTL,
           AMP.ER_CST AS ER_AMP_CST,
           CAD.ER_UTL AS ER_CAD_UTL,
           CAD.ER_CST AS ER_CAD_CST,
           CHF.ER_UTL AS ER_CHF_UTL,
           CHF.ER_CST AS ER_CHF_CST,
           ESRD.ER_UTL AS ER_ESRD_UTL,
           ESRD.ER_CST AS ER_ESRD_CST,
           HS.ER_UTL AS ER_HS_UTL,
           HS.ER_CST AS ER_HS_CST,
           IHD.ER_UTL AS ER_IHD_UTL,
           IHD.ER_CST AS ER_IHD_CST,
           IST.ER_UTL AS ER_IST_UTL,
           IST.ER_CST AS ER_IST_CST

    FROM DM_CMP_IP_ADD BASE
        LEFT JOIN DM_CMP_ER_OVR OVR ON BASE.MBR_ID = OVR.MBR_ID AND BASE.CAL_YR = OVR.CAL_YR AND BASE.BUSINESS_SEGMENT = OVR.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_ER_AMP AMP ON BASE.MBR_ID = AMP.MBR_ID AND BASE.CAL_YR = AMP.CAL_YR AND BASE.BUSINESS_SEGMENT = AMP.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_ER_CAD CAD ON BASE.MBR_ID = CAD.MBR_ID AND BASE.CAL_YR = CAD.CAL_YR AND BASE.BUSINESS_SEGMENT = CAD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_ER_CHF CHF ON BASE.MBR_ID = CHF.MBR_ID AND BASE.CAL_YR = CHF.CAL_YR AND BASE.BUSINESS_SEGMENT = CHF.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_ER_ESRD ESRD ON BASE.MBR_ID = ESRD.MBR_ID AND BASE.CAL_YR = ESRD.CAL_YR AND BASE.BUSINESS_SEGMENT = ESRD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_ER_HS HS ON BASE.MBR_ID = HS.MBR_ID AND BASE.CAL_YR = HS.CAL_YR AND BASE.BUSINESS_SEGMENT = HS.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_ER_IHD IHD ON BASE.MBR_ID = IHD.MBR_ID AND BASE.CAL_YR = IHD.CAL_YR AND BASE.BUSINESS_SEGMENT = IHD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_ER_IS IST ON BASE.MBR_ID = IST.MBR_ID AND BASE.CAL_YR = IST.CAL_YR AND BASE.BUSINESS_SEGMENT = IST.BUSINESS_SEGMENT
),

-- OUTPATIENT CLAIMS BREAKOUT --

-- ** STEP 27 ** --
--OUTPATIENT UTIL - SERVICES/CLAIM LINES
DM_CMP_OP_OVR AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT(CONCAT(CLMS.CLM_NBR, CLMS.CLM_LINE_NBR))) AS OP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS OP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT

    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
        AND CLMS.CLM_FORM_CODE = 'U' 
        AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('13', '83', '84', '85')

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 28 ** --
--OP AMPUTATION AMP
DM_CMP_OP_AMP AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS OP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS OP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'U' 
            AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('13', '83', '84', '85') 
            AND (CLMS.ICD_PROC_CODE_1 IN ('0Y6C0Z1','0Y6C0Z2','0Y6C0Z3','0Y6D0Z1','0Y6D0Z2',
                '0Y6D0Z3','0Y6H0Z1','0Y6H0Z2','0Y6H0Z3','0Y6J0Z1','0Y6J0Z2','0Y6J0Z3','0Y6P0Z0',
                '0Y6P0Z1','0Y6P0Z2','0Y6P0Z3','0Y6Q0Z0','0Y6Q0Z1','0Y6Q0Z2','0Y6Q0Z3','0Y6R0Z0',
                '0Y6R0Z1','0Y6R0Z2','0Y6R0Z3','0Y6S0Z0','0Y6S0Z1','0Y6S0Z2','0Y6S0Z3','0Y6T0Z0',
                '0Y6T0Z1','0Y6T0Z2','0Y6T0Z3','0Y6U0Z0','0Y6U0Z1','0Y6U0Z2','0Y6U0Z3','0Y6V0Z0',
                '0Y6V0Z1','0Y6V0Z2','0Y6V0Z3','0Y6W0Z0','0Y6W0Z1','0Y6W0Z2','0Y6W073','0Y6X0Z0',
                '0Y6X0Z1','0Y6X0Z2','0Y6X073','0Y6Y0Z0','0Y6Y0Z1','0Y6Y0Z2','0Y6Y073','0Y6M0Z4',
                '0Y6M0Z5','0Y6M0Z6','0Y6M0Z7','0Y6M0Z8','0Y6M0Z9','0Y6M0ZB','0Y6M0ZC','0Y6M0ZD',
                '0Y6M0ZF','0Y6N0Z4','0Y6N0Z5','0Y6N0Z6','0Y6N0Z7','0Y6N0Z8','0Y6N0Z9','0Y6N0ZB',
                '0Y6N0ZC','0Y6N0ZD','0Y6N0ZF','0Y6M0Z0','0Y6N0Z0','0Y6H0Z3','0Y6J0Z3','0Y6H0Z1',
                '0Y6H0Z2','0Y6H0Z3','0Y6J0Z1','0Y6J0Z2','0Y6J0Z3','0Y6F0ZZ','0Y6G0ZZ','0Y6C0Z1',
                '0Y6C0Z2','0Y6C0Z3','0Y6D0Z1','0Y6D0Z2','0Y6D0Z3','84.1','84.10','84.11','84.12',
                '84.13','84.14','84.15','84.16','84.17') 
                OR
                CLMS.CPT_CODE IN ('27590', '27591', '27592', '27593', '27594', '27595',
                '27596', '27597', '27598', '27880', '27881', '27882', '27884', '27886',
                '27888', '27889', '28800', '28805', '28810', '28820', '28825') 
                OR
                CLMS.SERV_CODE IN ('27590', '27591', '27592', '27593', '27594', '27595',
                '27596', '27597', '27598', '27880', '27881', '27882', '27884', '27886',
                '27888', '27889', '28800', '28805', '28810', '28820', '28825'))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),
DM_CMP_OP_CAD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS OP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS OP_CST

    FROM DM_CMP_ER_ADD BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'U' 
            AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('13', '83', '84', '85') 
            AND ((CLMS.CLM_PRIN_DIAG_CODE IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
                '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
                'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_1 IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
                '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
                'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_2 IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
                '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
                'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9')) 
                OR
                ((CLMS.ICD_PROC_CODE_1 IN ('00.66',	'36.0',	'36.03',	'36.04',	'36.07',	
                '36.09',	'36.1',	'36.10',	'36.11',	'36.12',	'36.13',	'36.14',	'36.15',	
                '36.16',	'36.17',	'36.19',	'02703ZZ',	'02704ZZ',	'02713ZZ',	'02714ZZ',	
                '02723ZZ',	'02724ZZ',	'02733ZZ',	'02734ZZ',	'02700ZZ',	'02710ZZ',	
                '02720ZZ',	'02730ZZ',	'02C00ZZ',	'02C10ZZ',	'02C20ZZ',	'02C30ZZ',	
                '3E07017',	'3E070PZ',	'3E07317',	'3E073PZ',	'02C03ZZ',	'02C04ZZ',	
                '02C13ZZ',	'02C14ZZ',	'02C23ZZ',	'02C24ZZ',	'02C33ZZ',	'02C34ZZ',	
                '0210093',	'02100A3',	'02100J3',	'02100K3',	'02100Z3',	'0210493',	
                '02104A3',	'02104J3',	'02104K3',	'02104Z3',	'021008W',	'021009W',	
                '02100AW',	'02100JW',	'02100KW',	'021048W',	'021049W',	'02104AW',	
                '02104JW',	'02104KW',	'021108W',	'021109W',	'02110AW',	'02110JW',	
                '02110KW',	'021148W',	'021149W',	'02114AW',	'02114JW',	'02114KW',	
                '021208W',	'021209W',	'02120AW',	'02120JW',	'02120KW',	'021248W',	
                '021249W',	'02124AW',	'02124JW',	'02124KW',	'021308W',	'021309W',	
                '02130AW',	'02130JW',	'02130KW',	'021348W',	'021349W',	'02134AW',	
                '02134JW',	'02134KW',	'0210088',	'0210089',	'021008C',	'0210098',	
                '0210099',	'021009C',	'02100A8',	'02100A9',	'02100AC',	'02100J8',	
                '02100J9',	'02100JC',	'02100K8',	'02100K9',	'02100KC',	'02100Z8',	
                '02100Z9',	'02100ZC',	'0210488',	'0210489',	'021048C',	'0210498',	
                '0210499',	'021049C',	'02104A8',	'02104A9',	'02104AC',	'02104J8',	
                '02104J9',	'02104JC',	'02104K8',	'02104K9',	'02104KC',	'02104Z8',	
                '02104Z9',	'02104ZC',	'0211088',	'0211089',	'021108C',	'0211098',	
                '0211099',	'021109C',	'02110A8',	'02110A9',	'02110AC',	'02110J8',	
                '02110J9',	'02110JC',	'02110K8',	'02110K9',	'02110KC',	'02110Z8',	
                '02110Z9',	'02110ZC',	'0211488',	'0211489',	'021148C',	'0211498',	
                '0211499',	'021149C',	'02114A8',	'02114A9',	'02114AC',	'02114J8',	
                '02114J9',	'02114JC',	'02114K8',	'02114K9',	'02114KC',	'02114Z8',	
                '02114Z9',	'02114ZC',	'021208C',	'021209C',	'02120AC',	'02120JC',	
                '02120KC',	'02120ZC',	'021248C',	'021249C',	'02124AC',	'02124JC',	
                '02124KC',	'02124ZC',	'021308C',	'021309C',	'02130AC',	'02130JC',	
                '02130KC',	'02130ZC',	'021348C',	'021349C',	'02134AC',	'02134JC',	
                '02134KC',	'02134ZC',	'021008F',	'021009F',	'02100AF',	'02100JF',	
                '02100KF',	'02100ZF',	'021048F',	'021049F',	'02104AF',	'02104JF',	
                '02104KF',	'02104ZF',	'0210083',	'0210093',	'02100A3',	'02100J3',	
                '02100K3',	'02100Z3',	'0210483',	'0210493',	'02104A3',	'02104J3',	
                '02104K3',	'02104Z3') 
                OR
                CLMS.ICD_PROC_CODE_2 IN ('00.66',	'36.0',	'36.03',	'36.04',	'36.07',	
                '36.09',	'36.1',	'36.10',	'36.11',	'36.12',	'36.13',	'36.14',	'36.15',	
                '36.16',	'36.17',	'36.19',	'02703ZZ',	'02704ZZ',	'02713ZZ',	'02714ZZ',	
                '02723ZZ',	'02724ZZ',	'02733ZZ',	'02734ZZ',	'02700ZZ',	'02710ZZ',	
                '02720ZZ',	'02730ZZ',	'02C00ZZ',	'02C10ZZ',	'02C20ZZ',	'02C30ZZ',	
                '3E07017',	'3E070PZ',	'3E07317',	'3E073PZ',	'02C03ZZ',	'02C04ZZ',	
                '02C13ZZ',	'02C14ZZ',	'02C23ZZ',	'02C24ZZ',	'02C33ZZ',	'02C34ZZ',	
                '0210093',	'02100A3',	'02100J3',	'02100K3',	'02100Z3',	'0210493',	
                '02104A3',	'02104J3',	'02104K3',	'02104Z3',	'021008W',	'021009W',	
                '02100AW',	'02100JW',	'02100KW',	'021048W',	'021049W',	'02104AW',	
                '02104JW',	'02104KW',	'021108W',	'021109W',	'02110AW',	'02110JW',	
                '02110KW',	'021148W',	'021149W',	'02114AW',	'02114JW',	'02114KW',	
                '021208W',	'021209W',	'02120AW',	'02120JW',	'02120KW',	'021248W',	
                '021249W',	'02124AW',	'02124JW',	'02124KW',	'021308W',	'021309W',	
                '02130AW',	'02130JW',	'02130KW',	'021348W',	'021349W',	'02134AW',	
                '02134JW',	'02134KW',	'0210088',	'0210089',	'021008C',	'0210098',	
                '0210099',	'021009C',	'02100A8',	'02100A9',	'02100AC',	'02100J8',	
                '02100J9',	'02100JC',	'02100K8',	'02100K9',	'02100KC',	'02100Z8',	
                '02100Z9',	'02100ZC',	'0210488',	'0210489',	'021048C',	'0210498',	
                '0210499',	'021049C',	'02104A8',	'02104A9',	'02104AC',	'02104J8',	
                '02104J9',	'02104JC',	'02104K8',	'02104K9',	'02104KC',	'02104Z8',	
                '02104Z9',	'02104ZC',	'0211088',	'0211089',	'021108C',	'0211098',	
                '0211099',	'021109C',	'02110A8',	'02110A9',	'02110AC',	'02110J8',	
                '02110J9',	'02110JC',	'02110K8',	'02110K9',	'02110KC',	'02110Z8',	
                '02110Z9',	'02110ZC',	'0211488',	'0211489',	'021148C',	'0211498',	
                '0211499',	'021149C',	'02114A8',	'02114A9',	'02114AC',	'02114J8',	
                '02114J9',	'02114JC',	'02114K8',	'02114K9',	'02114KC',	'02114Z8',	
                '02114Z9',	'02114ZC',	'021208C',	'021209C',	'02120AC',	'02120JC',	
                '02120KC',	'02120ZC',	'021248C',	'021249C',	'02124AC',	'02124JC',	
                '02124KC',	'02124ZC',	'021308C',	'021309C',	'02130AC',	'02130JC',	
                '02130KC',	'02130ZC',	'021348C',	'021349C',	'02134AC',	'02134JC',	
                '02134KC',	'02134ZC',	'021008F',	'021009F',	'02100AF',	'02100JF',	
                '02100KF',	'02100ZF',	'021048F',	'021049F',	'02104AF',	'02104JF',	
                '02104KF',	'02104ZF',	'0210083',	'0210093',	'02100A3',	'02100J3',	
                '02100K3',	'02100Z3',	'0210483',	'0210493',	'02104A3',	'02104J3',	
                '02104K3',	'02104Z3')) 
                OR
                (CLMS.CPT_CODE IN ('33140','92980','92981','92982','92984','92985','92986','92995',
                '92996','33510','33511','33512','33513','33514','33515','33516','33517','33518',
                '33519','33520','33521','33522','33523','33533','33534','33535','33536','33572') 
                OR
                CLMS.SERV_CODE IN ('33140','92980','92981','92982','92984','92985','92986','92995',
                '92996','33510','33511','33512','33513','33514','33515','33516','33517','33518',
                '33519','33520','33521','33522','33523','33533','33534','33535','33536','33572'))))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 31 ** --
--OP CHF
DM_CMP_OP_CHF AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS OP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS OP_CST
    
    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
    
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'U' 
            AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('13', '83', '84', '85') 
            AND (CLMS.CLM_PRIN_DIAG_CODE IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
                'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
                'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
                'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
                'I50.89','I50.9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_1 IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
                'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
                'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
                'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
                'I50.89','I50.9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_2 IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
                'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
                'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
                'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
                'I50.89','I50.9'))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 32 ** --
--OP ESRD
DM_CMP_OP_ESRD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS OP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS OP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'U' 
            AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('13', '83', '84', '85') 
            AND (CLMS.CPT_CODE IN ('90918', '90919', '90920', '90921', '90922', '90923',
                '90924', '90925', '90935', '90937', '90940', '90951', '90952', '90953',
                '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961',
                '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969',
                '90970') 
                OR
                CLMS.SERV_CODE IN ('90918', '90919', '90920', '90921', '90922', '90923',
                '90924', '90925', '90935', '90937', '90940', '90951', '90952', '90953',
                '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961',
                '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969',
                '90970'))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 33 ** --
--OP HEMORRHAGIC STROKE HS
DM_CMP_OP_HS AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS OP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS OP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'U' 
            AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('13', '83', '84', '85') 
            AND (CLMS.CLM_PRIN_DIAG_CODE IN ('432.0', '432.1', '432.2', '432.3', '432.4', '432.5',
                '432.6', '432.7', '432.8', '432.9', 'I61.0', 'I61.1', 'I61.2', 'I61.3',
                'I61.4', 'I61.5', 'I61.6', 'I61.8', 'I61.9', 'I62', 'I62.0', 'I62.00',
                'I62.01', 'I62.02', 'I62.03', 'I62.1', 'I62.9') 
                OR CLMS.CLM_PRIN_DIAG_CODE LIKE '430%' 
                OR CLMS.CLM_PRIN_DIAG_CODE LIKE '431%')
    
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 34 ** --
--OP ISHEMIC HEART DISEASE IHD
DM_CMP_OP_IHD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS OP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS OP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'U' 
            AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('13', '83', '84', '85') 
            AND (CLMS.CLM_PRIN_DIAG_CODE IN ('411','411.0','411.1','411.8','411.81','411.89','413',
                '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
                '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
                'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
                'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
                'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
                'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
                'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
                'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
                'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
                'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_1 IN ('411','411.0','411.1','411.8','411.81','411.89','413',
                '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
                '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
                'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
                'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
                'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
                'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
                'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
                'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
                'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
                'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_2 IN ('411','411.0','411.1','411.8','411.81','411.89','413',
                '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
                '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
                'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
                'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
                'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
                'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
                'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
                'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
                'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
                'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9'))
    
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 35 ** --
--OP ISCHEMIC STROKE IS
DM_CMP_OP_IS AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS OP_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS OP_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'U' 
            AND SUBSTR(CLMS.BILL_TYPE_CODE, 1, 2) IN ('13', '83', '84', '85') 
            AND (CLMS.CLM_PRIN_DIAG_CODE IN ('433.01', '433.11', '433.21', '433.31', '433.41', '433.81',
                '433.91', '434.01', '434.11', '434.91', 'I63', 'I63.0', 'I63.00',
                'I63.01', 'I63.011', 'I63.012', 'I63.013', 'I63.019', 'I63.02', 'I63.03',
                'I63.031', 'I63.032', 'I63.033', 'I63.039', 'I63.09', '163.1', 'I63.10',
                'I63.11', 'I63.111', 'I63.112', 'I63.113', 'I63.119', 'I63.12', 'I63.12',
                'I63.13', 'I63.131', 'I63.132', 'I63.133', 'I63.139', 'I63.19', 'I63.2',
                'I63.20', 'I63.21', 'I63.211', 'I63.212', 'I63.213', 'I63.219', 'I63.22',
                'I63.23', 'I63.231', 'I63.232', 'I63.233', 'I63.239', 'I63.29', 'I63.3',
                'I63.30', 'I63.31', 'I63.311', 'I63.312', 'I63.313', 'I63.319', 'I63.32',
                'I63.321', 'I63.322', 'I63.323', 'I63.329', 'I63.33', 'I63.331', 'I63.332',
                'I63.333', 'I63.339', 'I63.34', 'I63.341', 'I63.342', 'I63.343', 'I63.349',
                'I63.39', 'I63.4', 'I63.40', 'I63.41', 'I63.411', 'I63.412', 'I63.413',
                'I63.419', 'I63.42', 'I63.421', 'I63.422', 'I63.423', 'I63.429', 'I63.43',
                'I63.431', 'I63.432', 'I63.433', 'I63.439', 'I63.44', 'I63.441', 'I63.442',
                'I63.443', 'I63.449', 'I63.49', 'I63.5', 'I63.50', 'I63.51', 'I63.511',
                'I63.512', 'I63.513', 'I63.519', 'I63.52', 'I63.521', 'I63.522','I63.523',
                'I63.529', 'I63.53', 'I63.531', 'I63.532', 'I63.533', 'I63.539', 'I63.54',
                'I63.541', 'I63.542', 'I63.543', 'I63.549', 'I63.59', 'I63.6', 'I63.8',
                'I63.9', 'I63.81', 'I63.89') 
                OR CLMS.CLM_PRIN_DIAG_CODE LIKE '436%')

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- COMPILES ALL OP DATA TO PREVIOUS ER + IP + MEMBERSHIP TABLE --

-- ** STEP 36 ** --
--OP DATA
DM_CMP_OP_ADD AS
(
    SELECT BASE.*,
           OVR.OP_UTL AS OP_OVR_UTL,
           OVR.OP_CST AS OP_OVR_CST,
           AMP.OP_UTL AS OP_AMP_UTL,
           AMP.OP_CST AS OP_AMP_CST,
           CAD.OP_UTL AS OP_CAD_UTL,
           CAD.OP_CST AS OP_CAD_CST,
           CHF.OP_UTL AS OP_CHF_UTL,
           CHF.OP_CST AS OP_CHF_CST,
           ESRD.OP_UTL AS OP_ESRD_UTL,
           ESRD.OP_CST AS OP_ESRD_CST,
           HS.OP_UTL AS OP_HS_UTL,
           HS.OP_CST AS OP_HS_CST,
           IHD.OP_UTL AS OP_IHD_UTL,
           IHD.OP_CST AS OP_IHD_CST,
           IST.OP_UTL AS OP_IST_UTL,
           IST.OP_CST AS OP_IST_CST

    FROM DM_CMP_ER_ADD BASE
        LEFT JOIN DM_CMP_OP_OVR OVR ON BASE.MBR_ID = OVR.MBR_ID AND BASE.CAL_YR = OVR.CAL_YR AND BASE.BUSINESS_SEGMENT = OVR.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_OP_AMP AMP ON BASE.MBR_ID = AMP.MBR_ID AND BASE.CAL_YR = AMP.CAL_YR AND BASE.BUSINESS_SEGMENT = AMP.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_OP_CAD CAD ON BASE.MBR_ID = CAD.MBR_ID AND BASE.CAL_YR = CAD.CAL_YR AND BASE.BUSINESS_SEGMENT = CAD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_OP_CHF CHF ON BASE.MBR_ID = CHF.MBR_ID AND BASE.CAL_YR = CHF.CAL_YR AND BASE.BUSINESS_SEGMENT = CHF.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_OP_ESRD ESRD ON BASE.MBR_ID = ESRD.MBR_ID AND BASE.CAL_YR = ESRD.CAL_YR AND BASE.BUSINESS_SEGMENT = ESRD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_OP_HS HS ON BASE.MBR_ID = HS.MBR_ID AND BASE.CAL_YR = HS.CAL_YR AND BASE.BUSINESS_SEGMENT = HS.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_OP_IHD IHD ON BASE.MBR_ID = IHD.MBR_ID AND BASE.CAL_YR = IHD.CAL_YR AND BASE.BUSINESS_SEGMENT = IHD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_OP_IS IST ON BASE.MBR_ID = IST.MBR_ID AND BASE.CAL_YR = IST.CAL_YR AND BASE.BUSINESS_SEGMENT = IST.BUSINESS_SEGMENT
),

-- PROFESSIONAL CLAIMS BREAKOUT --

-- ** STEP 37 ** --
--PROFESSIONAL UTIL - SERVICES/CLAIM LINES
DM_CMP_PRF_OVR AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT(CONCAT(CLMS.CLM_NBR, CLMS.CLM_LINE_NBR))) AS PRF_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS PRF_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'H' 
            AND CLMS.POS_CODE IN ('21', '22', '24')
            
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),
-- ** STEP 38 ** --
--PRF AMPUTATION AMP
DM_CMP_PRF_AMP AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS PRF_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS PRF_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'H' 
            AND CLMS.POS_CODE IN ('21', '22', '24') 
            AND (CLMS.ICD_PROC_CODE_1 IN ('0Y6C0Z1','0Y6C0Z2','0Y6C0Z3','0Y6D0Z1','0Y6D0Z2',
                '0Y6D0Z3','0Y6H0Z1','0Y6H0Z2','0Y6H0Z3','0Y6J0Z1','0Y6J0Z2','0Y6J0Z3','0Y6P0Z0',
                '0Y6P0Z1','0Y6P0Z2','0Y6P0Z3','0Y6Q0Z0','0Y6Q0Z1','0Y6Q0Z2','0Y6Q0Z3','0Y6R0Z0',
                '0Y6R0Z1','0Y6R0Z2','0Y6R0Z3','0Y6S0Z0','0Y6S0Z1','0Y6S0Z2','0Y6S0Z3','0Y6T0Z0',
                '0Y6T0Z1','0Y6T0Z2','0Y6T0Z3','0Y6U0Z0','0Y6U0Z1','0Y6U0Z2','0Y6U0Z3','0Y6V0Z0',
                '0Y6V0Z1','0Y6V0Z2','0Y6V0Z3','0Y6W0Z0','0Y6W0Z1','0Y6W0Z2','0Y6W073','0Y6X0Z0',
                '0Y6X0Z1','0Y6X0Z2','0Y6X073','0Y6Y0Z0','0Y6Y0Z1','0Y6Y0Z2','0Y6Y073','0Y6M0Z4',
                '0Y6M0Z5','0Y6M0Z6','0Y6M0Z7','0Y6M0Z8','0Y6M0Z9','0Y6M0ZB','0Y6M0ZC','0Y6M0ZD',
                '0Y6M0ZF','0Y6N0Z4','0Y6N0Z5','0Y6N0Z6','0Y6N0Z7','0Y6N0Z8','0Y6N0Z9','0Y6N0ZB',
                '0Y6N0ZC','0Y6N0ZD','0Y6N0ZF','0Y6M0Z0','0Y6N0Z0','0Y6H0Z3','0Y6J0Z3','0Y6H0Z1',
                '0Y6H0Z2','0Y6H0Z3','0Y6J0Z1','0Y6J0Z2','0Y6J0Z3','0Y6F0ZZ','0Y6G0ZZ','0Y6C0Z1',
                '0Y6C0Z2','0Y6C0Z3','0Y6D0Z1','0Y6D0Z2','0Y6D0Z3','84.1','84.10','84.11','84.12',
                '84.13','84.14','84.15','84.16','84.17') 
                OR
                CLMS.CPT_CODE IN ('27590', '27591', '27592', '27593', '27594', '27595',
                '27596', '27597', '27598', '27880', '27881', '27882', '27884', '27886',
                '27888', '27889', '28800', '28805', '28810', '28820', '28825') 
                OR
                CLMS.SERV_CODE IN ('27590', '27591', '27592', '27593', '27594', '27595',
                '27596', '27597', '27598', '27880', '27881', '27882', '27884', '27886',
                '27888', '27889', '28800', '28805', '28810', '28820', '28825'))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),
DM_CMP_PRF_CAD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS PRF_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS PRF_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'H' 
            AND CLMS.POS_CODE IN ('21', '22', '24') 
            AND ((CLMS.CLM_PRIN_DIAG_CODE IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
                '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
                'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_1 IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
                '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
                'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_2 IN ('410','410.0','410.1','410.2','410.3','410.4','410.5','410.6',
                '410.7','410.8','410.9','I21','I21.0','I21.01','I21.02','I21.09','I21.1','I21.11',
                'I21.19','I21.2','I21.21','I21.29','I21.3','I21.4','I21.9','I21.A','I21.A1','I21.A9')) 
                OR
                ((CLMS.ICD_PROC_CODE_1 IN ('00.66',	'36.0',	'36.03',	'36.04',	'36.07',	
                '36.09',	'36.1',	'36.10',	'36.11',	'36.12',	'36.13',	'36.14',	'36.15',	
                '36.16',	'36.17',	'36.19',	'02703ZZ',	'02704ZZ',	'02713ZZ',	'02714ZZ',	
                '02723ZZ',	'02724ZZ',	'02733ZZ',	'02734ZZ',	'02700ZZ',	'02710ZZ',	
                '02720ZZ',	'02730ZZ',	'02C00ZZ',	'02C10ZZ',	'02C20ZZ',	'02C30ZZ',	
                '3E07017',	'3E070PZ',	'3E07317',	'3E073PZ',	'02C03ZZ',	'02C04ZZ',	
                '02C13ZZ',	'02C14ZZ',	'02C23ZZ',	'02C24ZZ',	'02C33ZZ',	'02C34ZZ',	
                '0210093',	'02100A3',	'02100J3',	'02100K3',	'02100Z3',	'0210493',	
                '02104A3',	'02104J3',	'02104K3',	'02104Z3',	'021008W',	'021009W',	
                '02100AW',	'02100JW',	'02100KW',	'021048W',	'021049W',	'02104AW',	
                '02104JW',	'02104KW',	'021108W',	'021109W',	'02110AW',	'02110JW',	
                '02110KW',	'021148W',	'021149W',	'02114AW',	'02114JW',	'02114KW',	
                '021208W',	'021209W',	'02120AW',	'02120JW',	'02120KW',	'021248W',	
                '021249W',	'02124AW',	'02124JW',	'02124KW',	'021308W',	'021309W',	
                '02130AW',	'02130JW',	'02130KW',	'021348W',	'021349W',	'02134AW',	
                '02134JW',	'02134KW',	'0210088',	'0210089',	'021008C',	'0210098',	
                '0210099',	'021009C',	'02100A8',	'02100A9',	'02100AC',	'02100J8',	
                '02100J9',	'02100JC',	'02100K8',	'02100K9',	'02100KC',	'02100Z8',	
                '02100Z9',	'02100ZC',	'0210488',	'0210489',	'021048C',	'0210498',	
                '0210499',	'021049C',	'02104A8',	'02104A9',	'02104AC',	'02104J8',	
                '02104J9',	'02104JC',	'02104K8',	'02104K9',	'02104KC',	'02104Z8',	
                '02104Z9',	'02104ZC',	'0211088',	'0211089',	'021108C',	'0211098',	
                '0211099',	'021109C',	'02110A8',	'02110A9',	'02110AC',	'02110J8',	
                '02110J9',	'02110JC',	'02110K8',	'02110K9',	'02110KC',	'02110Z8',	
                '02110Z9',	'02110ZC',	'0211488',	'0211489',	'021148C',	'0211498',	
                '0211499',	'021149C',	'02114A8',	'02114A9',	'02114AC',	'02114J8',	
                '02114J9',	'02114JC',	'02114K8',	'02114K9',	'02114KC',	'02114Z8',	
                '02114Z9',	'02114ZC',	'021208C',	'021209C',	'02120AC',	'02120JC',	
                '02120KC',	'02120ZC',	'021248C',	'021249C',	'02124AC',	'02124JC',	
                '02124KC',	'02124ZC',	'021308C',	'021309C',	'02130AC',	'02130JC',	
                '02130KC',	'02130ZC',	'021348C',	'021349C',	'02134AC',	'02134JC',	
                '02134KC',	'02134ZC',	'021008F',	'021009F',	'02100AF',	'02100JF',	
                '02100KF',	'02100ZF',	'021048F',	'021049F',	'02104AF',	'02104JF',	
                '02104KF',	'02104ZF',	'0210083',	'0210093',	'02100A3',	'02100J3',	
                '02100K3',	'02100Z3',	'0210483',	'0210493',	'02104A3',	'02104J3',	
                '02104K3',	'02104Z3') 
                OR
                CLMS.ICD_PROC_CODE_2 IN ('00.66',	'36.0',	'36.03',	'36.04',	'36.07',	
                '36.09',	'36.1',	'36.10',	'36.11',	'36.12',	'36.13',	'36.14',	'36.15',	
                '36.16',	'36.17',	'36.19',	'02703ZZ',	'02704ZZ',	'02713ZZ',	'02714ZZ',	
                '02723ZZ',	'02724ZZ',	'02733ZZ',	'02734ZZ',	'02700ZZ',	'02710ZZ',	
                '02720ZZ',	'02730ZZ',	'02C00ZZ',	'02C10ZZ',	'02C20ZZ',	'02C30ZZ',	
                '3E07017',	'3E070PZ',	'3E07317',	'3E073PZ',	'02C03ZZ',	'02C04ZZ',	
                '02C13ZZ',	'02C14ZZ',	'02C23ZZ',	'02C24ZZ',	'02C33ZZ',	'02C34ZZ',	
                '0210093',	'02100A3',	'02100J3',	'02100K3',	'02100Z3',	'0210493',	
                '02104A3',	'02104J3',	'02104K3',	'02104Z3',	'021008W',	'021009W',	
                '02100AW',	'02100JW',	'02100KW',	'021048W',	'021049W',	'02104AW',	
                '02104JW',	'02104KW',	'021108W',	'021109W',	'02110AW',	'02110JW',	
                '02110KW',	'021148W',	'021149W',	'02114AW',	'02114JW',	'02114KW',	
                '021208W',	'021209W',	'02120AW',	'02120JW',	'02120KW',	'021248W',	
                '021249W',	'02124AW',	'02124JW',	'02124KW',	'021308W',	'021309W',	
                '02130AW',	'02130JW',	'02130KW',	'021348W',	'021349W',	'02134AW',	
                '02134JW',	'02134KW',	'0210088',	'0210089',	'021008C',	'0210098',	
                '0210099',	'021009C',	'02100A8',	'02100A9',	'02100AC',	'02100J8',	
                '02100J9',	'02100JC',	'02100K8',	'02100K9',	'02100KC',	'02100Z8',	
                '02100Z9',	'02100ZC',	'0210488',	'0210489',	'021048C',	'0210498',	
                '0210499',	'021049C',	'02104A8',	'02104A9',	'02104AC',	'02104J8',	
                '02104J9',	'02104JC',	'02104K8',	'02104K9',	'02104KC',	'02104Z8',	
                '02104Z9',	'02104ZC',	'0211088',	'0211089',	'021108C',	'0211098',	
                '0211099',	'021109C',	'02110A8',	'02110A9',	'02110AC',	'02110J8',	
                '02110J9',	'02110JC',	'02110K8',	'02110K9',	'02110KC',	'02110Z8',	
                '02110Z9',	'02110ZC',	'0211488',	'0211489',	'021148C',	'0211498',	
                '0211499',	'021149C',	'02114A8',	'02114A9',	'02114AC',	'02114J8',	
                '02114J9',	'02114JC',	'02114K8',	'02114K9',	'02114KC',	'02114Z8',	
                '02114Z9',	'02114ZC',	'021208C',	'021209C',	'02120AC',	'02120JC',	
                '02120KC',	'02120ZC',	'021248C',	'021249C',	'02124AC',	'02124JC',	
                '02124KC',	'02124ZC',	'021308C',	'021309C',	'02130AC',	'02130JC',	
                '02130KC',	'02130ZC',	'021348C',	'021349C',	'02134AC',	'02134JC',	
                '02134KC',	'02134ZC',	'021008F',	'021009F',	'02100AF',	'02100JF',	
                '02100KF',	'02100ZF',	'021048F',	'021049F',	'02104AF',	'02104JF',	
                '02104KF',	'02104ZF',	'0210083',	'0210093',	'02100A3',	'02100J3',	
                '02100K3',	'02100Z3',	'0210483',	'0210493',	'02104A3',	'02104J3',	
                '02104K3',	'02104Z3')) 
                OR
                (CLMS.CPT_CODE IN ('33140','92980','92981','92982','92984','92985','92986','92995',
                '92996','33510','33511','33512','33513','33514','33515','33516','33517','33518',
                '33519','33520','33521','33522','33523','33533','33534','33535','33536','33572') 
                OR
                CLMS.SERV_CODE IN ('33140','92980','92981','92982','92984','92985','92986','92995',
                '92996','33510','33511','33512','33513','33514','33515','33516','33517','33518',
                '33519','33520','33521','33522','33523','33533','33534','33535','33536','33572'))))

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 41 ** --
--PRF CHF
DM_CMP_PRF_CHF AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS PRF_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS PRF_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'H' 
            AND CLMS.POS_CODE IN ('21', '22', '24') 
            AND (CLMS.CLM_PRIN_DIAG_CODE IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
                'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
                'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
                'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
                'I50.89','I50.9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_1 IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
                'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
                'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
                'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
                'I50.89','I50.9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_2 IN ('428','428.0','428.1','428.2','428.3','428.4','428.9',
                'I50.1','I50.2','I50.20','I50.21','I50.22','I50.23','I50.3','I50.30','I50.31',
                'I50.32','I50.33','I50.4','I50.40','I50.41','I50.42','I50.43','I50.8','I50.81',
                'I50.810','I50.811','I50.812','I50.813','I50.814','I50.82','I50.83','I50.84',
                'I50.89','I50.9'))
                
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 42 ** --
--PRF ESRD
DM_CMP_PRF_ESRD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS PRF_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS PRF_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'H' 
            AND CLMS.POS_CODE IN ('21', '22', '24') 
            AND (CLMS.CPT_CODE IN ('90918', '90919', '90920', '90921', '90922', '90923',
                '90924', '90925', '90935', '90937', '90940', '90951', '90952', '90953',
                '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961',
                '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969',
                '90970') 
                OR
                CLMS.SERV_CODE IN ('90918', '90919', '90920', '90921', '90922', '90923',
                '90924', '90925', '90935', '90937', '90940', '90951', '90952', '90953',
                '90954', '90955', '90956', '90957', '90958', '90959', '90960', '90961',
                '90962', '90963', '90964', '90965', '90966', '90967', '90968', '90969',
                '90970'))
                
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),    

-- ** STEP 43 ** --
--PRF HEMORRHAGIC STROKE HS
DM_CMP_PRF_HS AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS PRF_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS PRF_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'H' 
            AND CLMS.POS_CODE IN ('21', '22', '24') 
            AND (CLMS.CLM_PRIN_DIAG_CODE IN ('432.0', '432.1', '432.2', '432.3', '432.4', '432.5',
                '432.6', '432.7', '432.8', '432.9', 'I61.0', 'I61.1', 'I61.2', 'I61.3',
                'I61.4', 'I61.5', 'I61.6', 'I61.8', 'I61.9', 'I62', 'I62.0', 'I62.00',
                'I62.01', 'I62.02', 'I62.03', 'I62.1', 'I62.9') 
                OR 
                CLMS.CLM_PRIN_DIAG_CODE LIKE '430%' OR CLMS.CLM_PRIN_DIAG_CODE LIKE '431%')

    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 44 ** --
--PRF ISHEMIC HEART DISEASE IHD
DM_CMP_PRF_IHD AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS PRF_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS PRF_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'H' 
            AND CLMS.POS_CODE IN ('21', '22', '24') 
            AND (CLMS.CLM_PRIN_DIAG_CODE IN ('411','411.0','411.1','411.8','411.81','411.89','413',
                '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
                '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
                'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
                'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
                'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
                'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
                'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
                'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
                'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
                'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_1 IN ('411','411.0','411.1','411.8','411.81','411.89','413',
                '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
                '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
                'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
                'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
                'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
                'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
                'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
                'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
                'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
                'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9') 
                OR
                CLMS.CLM_OTHER_DIAG_CODE_2 IN ('411','411.0','411.1','411.8','411.81','411.89','413',
                '413.0','413.1','413.9','414','414.0','414.00','414.01','414.02','414.03',
                '414.04','414.05','414.06','414.07','I25','I25.1','I25.10','I25.11','I25.110',
                'I25.111','I25.118','I25.119','I25.2','I25.3','I25.4','I25.41','I25.42','I25.5',
                'I25.6','I25.7','I25.70','I25.700','I25.701','I25.708','I25.709','I25.71','I25.710',
                'I25.711','I25.718','I15.719','I24.72','I25.720','I25.721','I25.728','I25.729',
                'I25.73','I25.730','I25.731','I25.738','I25.739','I25.75','I25.750','I25.751',
                'I25.758','I25.759','I25.76','I25.760','I25.761','I25.768','I25.769','I25.79',
                'I25.790','I25.791','I25.798','I25.799','I25.8','I25.81','I25.810','I25.811',
                'I25.812','I25.82','I25.83','I25.84','I25.89','I25.9','I20','I20.0','I20.1',
                'I20.8','I20.9','I24','I24.0','I24.1','I24.8','I24.9'))
                
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- ** STEP 45 ** --
--PRF ISCHEMIC STROKE IS
DM_CMP_PRF_IS AS
(
    SELECT BASE.MBR_ID, 
           BASE.CAL_YR,
           BASE.BUSINESS_SEGMENT,
           COUNT(DISTINCT CLMS.CLM_NBR) AS PRF_UTL,
           SUM(CLMS.CALC_ALWD_AMT) AS PRF_CST

    FROM DM_CMP_BASE BASE
        LEFT JOIN DM_CMP_CLM CLMS ON BASE.MBR_ID = CLMS.MBR_ID 
            AND BASE.CAL_YR = CLMS.SERV_YEAR 
            AND BASE.BUSINESS_SEGMENT = CLMS.BUSINESS_SEGMENT
            
    WHERE CLMS.SERV_LINE_START_DATE >= BASE.DIABETES_FIRST_RUN_DT 
            AND CLMS.CLM_FORM_CODE = 'H' 
            AND CLMS.POS_CODE IN ('21', '22', '24') 
            AND (CLMS.CLM_PRIN_DIAG_CODE IN ('433.01', '433.11', '433.21', '433.31', '433.41', '433.81',
                '433.91', '434.01', '434.11', '434.91', 'I63', 'I63.0', 'I63.00',
                'I63.01', 'I63.011', 'I63.012', 'I63.013', 'I63.019', 'I63.02', 'I63.03',
                'I63.031', 'I63.032', 'I63.033', 'I63.039', 'I63.09', '163.1', 'I63.10',
                'I63.11', 'I63.111', 'I63.112', 'I63.113', 'I63.119', 'I63.12', 'I63.12',
                'I63.13', 'I63.131', 'I63.132', 'I63.133', 'I63.139', 'I63.19', 'I63.2',
                'I63.20', 'I63.21', 'I63.211', 'I63.212', 'I63.213', 'I63.219', 'I63.22',
                'I63.23', 'I63.231', 'I63.232', 'I63.233', 'I63.239', 'I63.29', 'I63.3',
                'I63.30', 'I63.31', 'I63.311', 'I63.312', 'I63.313', 'I63.319', 'I63.32',
                'I63.321', 'I63.322', 'I63.323', 'I63.329', 'I63.33', 'I63.331', 'I63.332',
                'I63.333', 'I63.339', 'I63.34', 'I63.341', 'I63.342', 'I63.343', 'I63.349',
                'I63.39', 'I63.4', 'I63.40', 'I63.41', 'I63.411', 'I63.412', 'I63.413',
                'I63.419', 'I63.42', 'I63.421', 'I63.422', 'I63.423', 'I63.429', 'I63.43',
                'I63.431', 'I63.432', 'I63.433', 'I63.439', 'I63.44', 'I63.441', 'I63.442',
                'I63.443', 'I63.449', 'I63.49', 'I63.5', 'I63.50', 'I63.51', 'I63.511',
                'I63.512', 'I63.513', 'I63.519', 'I63.52', 'I63.521', 'I63.522','I63.523',
                'I63.529', 'I63.53', 'I63.531', 'I63.532', 'I63.533', 'I63.539', 'I63.54',
                'I63.541', 'I63.542', 'I63.543', 'I63.549', 'I63.59', 'I63.6', 'I63.8',
                'I63.9', 'I63.81', 'I63.89') 
                OR CLMS.CLM_PRIN_DIAG_CODE LIKE '436%')
                
    GROUP BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
    ORDER BY BASE.MBR_ID, BASE.CAL_YR, BASE.BUSINESS_SEGMENT
),

-- COMPILES ALL PRF DATA TO PREVIOUS OP + ER + IP + MEMBERSHIP TABLE --

-- ** STEP 46 ** --
--PRF DATA
DM_CMP_PRF_ADD AS
(
    SELECT BASE.*,
           OVR.PRF_UTL AS PRF_OVR_UTL,
           OVR.PRF_CST AS PRF_OVR_CST,
           AMP.PRF_UTL AS PRF_AMP_UTL,
           AMP.PRF_CST AS PRF_AMP_CST,
           CAD.PRF_UTL AS PRF_CAD_UTL,
           CAD.PRF_CST AS PRF_CAD_CST,
           CHF.PRF_UTL AS PRF_CHF_UTL,
           CHF.PRF_CST AS PRF_CHF_CST,
           ESRD.PRF_UTL AS PRF_ESRD_UTL,
           ESRD.PRF_CST AS PRF_ESRD_CST,
           HS.PRF_UTL AS PRF_HS_UTL,
           HS.PRF_CST AS PRF_HS_CST,
           IHD.PRF_UTL AS PRF_IHD_UTL,
           IHD.PRF_CST AS PRF_IHD_CST,
           IST.PRF_UTL AS PRF_IST_UTL,
           IST.PRF_CST AS PRF_IST_CST

    FROM DM_CMP_OP_ADD BASE
        LEFT JOIN DM_CMP_PRF_OVR OVR ON BASE.MBR_ID = OVR.MBR_ID AND BASE.CAL_YR = OVR.CAL_YR AND BASE.BUSINESS_SEGMENT = OVR.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_PRF_AMP AMP ON BASE.MBR_ID = AMP.MBR_ID AND BASE.CAL_YR = AMP.CAL_YR AND BASE.BUSINESS_SEGMENT = AMP.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_PRF_CAD CAD ON BASE.MBR_ID = CAD.MBR_ID AND BASE.CAL_YR = CAD.CAL_YR AND BASE.BUSINESS_SEGMENT = CAD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_PRF_CHF CHF ON BASE.MBR_ID = CHF.MBR_ID AND BASE.CAL_YR = CHF.CAL_YR AND BASE.BUSINESS_SEGMENT = CHF.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_PRF_ESRD ESRD ON BASE.MBR_ID = ESRD.MBR_ID AND BASE.CAL_YR = ESRD.CAL_YR AND BASE.BUSINESS_SEGMENT = ESRD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_PRF_HS HS ON BASE.MBR_ID = HS.MBR_ID AND BASE.CAL_YR = HS.CAL_YR AND BASE.BUSINESS_SEGMENT = HS.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_PRF_IHD IHD ON BASE.MBR_ID = IHD.MBR_ID AND BASE.CAL_YR = IHD.CAL_YR AND BASE.BUSINESS_SEGMENT = IHD.BUSINESS_SEGMENT
        LEFT JOIN DM_CMP_PRF_IS IST ON BASE.MBR_ID = IST.MBR_ID AND BASE.CAL_YR = IST.CAL_YR AND BASE.BUSINESS_SEGMENT = IST.BUSINESS_SEGMENT
),

-- ADDS COMPLICATION FLAG TO PREVIOUS PRF + OP + ER + IP + MEMBERSHIP TABLE --

-- ** STEP 47 ** --
--ADD COMPLICATION INDICATORS
DM_CMP_IND_ADD AS
(
    SELECT T1.*,
           CASE 
                WHEN IP_AMP_UTL > 0 THEN 1 
                ELSE 0 END AS AMP_IND,
           CASE 
                WHEN IP_CAD_UTL > 0 THEN 1
                ELSE 0 END AS CAD_IND,
           CASE 
                WHEN IP_CHF_UTL > 0 OR ER_CHF_UTL > 0 OR OP_CHF_UTL > 0 OR PRF_CHF_UTL > 0 THEN 1 
                ELSE 0 END AS CHF_IND,
           CASE 
                WHEN IP_ESRD_UTL > 0 OR ER_ESRD_UTL > 0 OR OP_ESRD_UTL > 0 OR PRF_ESRD_UTL > 0 THEN 1 
                ELSE 0 END AS ESRD_IND,
           CASE 
               WHEN IP_HS_UTL > 0 OR ER_HS_UTL > 0 THEN 1 
               ELSE 0 END AS HS_IND,
           CASE 
               WHEN IP_IHD_UTL > 0 OR ER_IHD_UTL > 0 OR OP_IHD_UTL > 1 OR PRF_IHD_UTL > 1 THEN 1 
               ELSE 0 END AS IHD_IND,
           CASE 
               WHEN IP_IST_UTL > 0 OR ER_IST_UTL > 0 THEN 1 
               ELSE 0 END AS IST_IND

    FROM DM_CMP_PRF_ADD T1
),

-- ** STEP 68 ** --
--ADD COND_IND
DM_CMP_COND AS
(
    SELECT BASE.*,
           CASE WHEN AMP_IND = 1 OR CAD_IND = 1 OR CHF_IND = 1 OR ESRD_IND = 1 OR HS_IND = 1 OR IHD_IND = 1 OR IST_IND = 1 THEN 1 
                ELSE 0 END AS COND_IND
    FROM DM_CMP_IND_ADD BASE
), 
data_pull_members as(
select distinct empi from DM_CMP_COND
where cond_ind = 0
)